<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard - Medsync.ai</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                <div class="logo-icon">
                    <i class="fas fa-hospital"></i>
                </div>
                <span>Medsync.ai</span>
            </a>
            <nav class="nav-links">
                <a href="{{ url_for('clinic_patients') }}" class="nav-link">
                    <i class="fas fa-users"></i> Patients
                </a>
                <a href="{{ url_for('clinic_appointments') }}" class="nav-link">
                    <i class="fas fa-calendar-alt"></i> Appointments
                </a>
                <a href="{{ url_for('chatbot') }}" class="nav-link">
                    <i class="fas fa-robot"></i> AI Assistant
                </a>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--foreground); margin-bottom: 0.5rem;">Clinic Dashboard</h1>
        <p style="color: var(--muted-foreground); font-size: 1.1rem; margin-bottom: 2rem;">Monitor patient activity and manage appointments</p>

        <!-- Added live update indicator and refresh button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="live-status" style="display: flex; align-items: center; gap: 0.5rem; color: var(--success);">
                    <div id="live-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite;"></div>
                    <span>Live Updates Active</span>
                </div>
                <button id="refresh-btn" class="btn btn-secondary" onclick="forceRefresh()">
                    <i class="fas fa-sync-alt"></i> Refresh Now
                </button>
            </div>
            <div id="last-updated" style="color: var(--muted-foreground); font-size: 0.875rem;">
                Last updated: Never
            </div>
        </div>

        <div class="grid grid-2" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom: 2rem;">
            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="total-patients">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Total Patients</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="total-appointments">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Total Appointments</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="today-appointments">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Today's Appointments</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="active-medications">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Active Medications</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="margin-bottom: 2rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-calendar-alt"></i>
                        Recent Appointments
                    </div>
                </div>
                <div class="card-content">
                    <div style="overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border);">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Patient</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Doctor</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Date & Time</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Status</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-appointments">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading appointments...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-activity"></i>
                        Recent Activity
                    </div>
                </div>
                <div class="card-content">
                    <div id="recent-activity">
                        <div style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-users"></i>
                    Patient Overview
                </div>
            </div>
            <div class="card-content">
                <div style="overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Name</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Email</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Phone</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Total Appointments</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Medications</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patients-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading patients...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator hidden">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text"></span>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let updateInterval;
        let isUpdating = false;
        let lastUpdateTime = null;
    
        // Show notification function
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.style.background = isSuccess ? 'var(--success)' : 'var(--destructive)';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Set loading state
        function setLoading(loading) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator && loading) {
                loadingIndicator.classList.remove('hidden');
            } else if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function fetchData(endpoint, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`Fetch error (attempt ${i + 1}):`, error);
                    if (i === retries - 1) {
                        throw error;
                    }
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        async function updateStats() {
            try {
                const stats = await fetchData('/dashboard/stats');
                
                if (stats) {
                    // Animate number changes
                    animateNumber('total-patients', stats.total_patients || 0);
                    animateNumber('total-appointments', stats.total_appointments || 0);
                    animateNumber('today-appointments', stats.today_appointments || 0);
                    animateNumber('active-medications', stats.active_medications || 0);
                }
                updateLiveStatus(true);
            } catch (error) {
                console.error('Error updating stats:', error);
                updateLiveStatus(false);
            }
        }

        function animateNumber(elementId, newValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue !== newValue) {
                element.style.transform = 'scale(1.1)';
                element.style.color = 'var(--primary)';
                
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.transform = 'scale(1)';
                    element.style.color = 'var(--foreground)';
                }, 150);
            } else {
                element.textContent = newValue;
            }
        }

        function updateLiveStatus(isConnected) {
            const liveStatus = document.getElementById('live-status');
            const liveIndicator = document.getElementById('live-indicator');
            const lastUpdated = document.getElementById('last-updated');
            
            if (isConnected) {
                liveStatus.style.color = 'var(--success)';
                liveIndicator.style.background = 'var(--success)';
                liveStatus.querySelector('span').textContent = 'Live Updates Active';
                lastUpdateTime = new Date();
                lastUpdated.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
            } else {
                liveStatus.style.color = 'var(--destructive)';
                liveIndicator.style.background = 'var(--destructive)';
                liveStatus.querySelector('span').textContent = 'Connection Lost';
            }
        }

        async function loadRecentAppointments() {
            try {
                const appointments = await fetchData('/dashboard/recent-appointments');
                const tbody = document.getElementById('recent-appointments');
                
                if (!appointments) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load appointments</td></tr>';
                    return;
                }

                if (appointments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No appointments found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = appointments.map(apt => {
                    const appointmentDate = new Date(apt.appointment_date);
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; vertical-align: top;">
                                <strong>${apt.patient_first_name} ${apt.patient_last_name}</strong><br>
                                <small style="color: var(--muted-foreground)">ID: ${apt.patient_id}</small>
                            </td>
                            <td style="padding: 1rem; vertical-align: top;">
                                Dr. ${apt.doctor_first_name} ${apt.doctor_last_name}<br>
                                <small style="color: var(--muted-foreground)">${apt.specialization}</small>
                            </td>
                            <td style="padding: 1rem; vertical-align: top;">
                                ${appointmentDate.toLocaleDateString()}<br>
                                <small style="color: var(--muted-foreground)">${appointmentDate.toLocaleTimeString()}</small>
                            </td>
                            <td style="padding: 1rem; vertical-align: top;">
                                <span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; ${getStatusStyle(apt.status)}">${apt.status}</span>
                            </td>
                            <td style="padding: 1rem; vertical-align: top;">
                                <select onchange="updateAppointmentStatus(${apt.appointment_id}, this.value)" style="background: var(--muted); color: var(--foreground); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 0.875rem; cursor: pointer;">
                                    <option value="scheduled" ${apt.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                    <option value="completed" ${apt.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${apt.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading appointments:', error);
                const tbody = document.getElementById('recent-appointments');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load appointments</td></tr>';
            }
        }

        // Get status badge styling
        function getStatusStyle(status) {
            switch(status) {
                case 'scheduled':
                    return 'background: #dbeafe; color: #1e40af;';
                case 'completed':
                    return 'background: #dcfce7; color: #166534;';
                case 'cancelled':
                    return 'background: #fee2e2; color: #dc2626;';
                default:
                    return 'background: var(--muted); color: var(--foreground);';
            }
        }

        // Load patients overview
        async function loadPatientsOverview() {
            try {
                const patients = await fetchData('/dashboard/patients-overview');
                const tbody = document.getElementById('patients-table');
                
                if (!patients) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load patients</td></tr>';
                    return;
                }

                if (patients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No patients found</td></tr>';
                    return;
                }

                tbody.innerHTML = patients.map(patient => {
                    const dob = patient.dob ? new Date(patient.dob).toLocaleDateString() : 'N/A';
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; vertical-align: top;">
                                <strong>${patient.first_name} ${patient.last_name}</strong><br>
                                <small style="color: var(--muted-foreground)">DOB: ${dob}</small>
                            </td>
                            <td style="padding: 1rem; vertical-align: top;">${patient.email}</td>
                            <td style="padding: 1rem; vertical-align: top;">${patient.phone || 'N/A'}</td>
                            <td style="padding: 1rem; vertical-align: top;">${patient.total_appointments || 0}</td>
                            <td style="padding: 1rem; vertical-align: top;">${patient.total_medications || 0}</td>
                            <td style="padding: 1rem; vertical-align: top;">
                                <a href="/clinic/patients?patient_id=${patient.patient_id}" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading patients:', error);
                const tbody = document.getElementById('patients-table');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load patients</td></tr>';
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const activities = await fetchData('/dashboard/recent-activity');
                const activityDiv = document.getElementById('recent-activity');
                
                if (!activities) {
                    activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load activity</div>';
                    return;
                }

                if (activities.length === 0) {
                    activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No recent activity</div>';
                    return;
                }

                activityDiv.innerHTML = activities.map(activity => {
                    const activityTime = new Date(activity.time);
                    const icon = activity.status === 'completed' ? 'check-circle' : 'calendar-alt';
                    
                    return `
                        <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--border);">
                            <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: white; flex-shrink: 0; background: var(--primary);">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--foreground); margin-bottom: 0.25rem;">${activity.title}</div>
                                <div style="color: var(--muted-foreground); font-size: 0.875rem; margin-bottom: 0.25rem;">${activity.description}</div>
                                <div style="color: var(--muted-foreground); font-size: 0.75rem;">${activityTime.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading activity:', error);
                const activityDiv = document.getElementById('recent-activity');
                activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load activity</div>';
            }
        }

        // Update appointment status
        async function updateAppointmentStatus(appointmentId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/clinic/appointments/${appointmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    // Reload the appointments table
                    await loadRecentAppointments();
                    await loadRecentActivity();
                    
                    // Show success message
                    showNotification('Appointment status updated successfully');
                } else {
                    throw new Error('Failed to update appointment status');
                }
            } catch (error) {
                console.error('Error updating appointment status:', error);
                showNotification('Failed to update appointment status', false);
            }
        }

        async function initDashboard() {
            if (isUpdating) return;
            isUpdating = true;
            setLoading(true);
            
            try {
                await Promise.all([
                    updateStats(),
                    loadRecentAppointments(),
                    loadPatientsOverview(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showNotification('Failed to load dashboard data', false);
                updateLiveStatus(false);
            } finally {
                isUpdating = false;
                setLoading(false);
            }
        }

        async function forceRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            
            try {
                await initDashboard();
                showNotification('Dashboard refreshed successfully');
            } catch (error) {
                showNotification('Failed to refresh dashboard', false);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Initial load
            await initDashboard();
            
            // Set up live updates every 15 seconds
            updateInterval = setInterval(initDashboard, 15000);
            
            // Handle page visibility changes to pause/resume updates
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                } else {
                    if (!updateInterval) {
                        updateInterval = setInterval(initDashboard, 15000);
                        initDashboard(); // Immediate refresh when page becomes visible
                    }
                }
            });
        });

        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>

    <!-- Added CSS for live update animations -->
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</body>
</html>
