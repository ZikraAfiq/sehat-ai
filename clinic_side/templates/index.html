<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard - Medsync.ai</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                <div class="logo-icon">
                    <i class="fas fa-hospital"></i>
                </div>
                <span>Medsync.ai</span>
            </a>
            <nav class="nav-links">
                <a href="{{ url_for('clinic_patients') }}" class="nav-link">
                    <i class="fas fa-users"></i> Patients
                </a>
                <a href="{{ url_for('clinic_appointments') }}" class="nav-link">
                    <i class="fas fa-calendar-alt"></i> Appointments
                </a>
                <a href="{{ url_for('chatbot') }}" class="nav-link">
                    <i class="fas fa-robot"></i> AI Assistant
                </a>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--foreground); margin-bottom: 0.5rem;">Clinic Dashboard</h1>
        <p style="color: var(--muted-foreground); font-size: 1.1rem; margin-bottom: 2rem;">Monitor patient activity and manage appointments</p>

        <div class="grid grid-2" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom: 2rem;">
            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="total-patients">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Total Patients</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="total-appointments">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Total Appointments</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="today-appointments">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Today's Appointments</div>
                    </div>
                </div>
            </div>

            <div class="card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--foreground); line-height: 1;" id="active-medications">-</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.25rem;">Active Medications</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="margin-bottom: 2rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-calendar-alt"></i>
                        Recent Appointments
                    </div>
                </div>
                <div class="card-content">
                    <div style="overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border);">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Patient</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Doctor</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Date & Time</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Status</th>
                                    <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-appointments">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading appointments...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-activity"></i>
                        Recent Activity
                    </div>
                </div>
                <div class="card-content">
                    <div id="recent-activity">
                        <div style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-users"></i>
                    Patient Overview
                </div>
            </div>
            <div class="card-content">
                <div style="overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Name</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Email</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Phone</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Total Appointments</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Medications</th>
                                <th style="background: var(--muted); padding: 1rem; text-align: left; font-weight: 600; color: var(--foreground); border-bottom: 1px solid var(--border);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patients-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">Loading patients...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator hidden">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text"></span>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
    
        // Fetch data from API with error handling
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }
    
        // Update statistics
        async function updateStats() {
            try {
                const stats = await fetchData('/dashboard/stats');
                
                if (stats) {
                    document.getElementById('total-patients').textContent = stats.total_patients || 0;
                    document.getElementById('total-appointments').textContent = stats.total_appointments || 0;
                    document.getElementById('today-appointments').textContent = stats.today_appointments || 0;
                    document.getElementById('active-medications').textContent = stats.active_medications || 0;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
    
        // Load recent appointments
        async function loadRecentAppointments() {
            const appointments = await fetchData('/dashboard/recent-appointments');
            const tbody = document.getElementById('recent-appointments');
            
            if (!appointments) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load appointments</td></tr>';
                return;
            }
    
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No appointments found</td></tr>';
                return;
            }
            
            tbody.innerHTML = appointments.map(apt => {
                const appointmentDate = new Date(apt.appointment_date);
                return `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; vertical-align: top;">
                            <strong>${apt.patient_first_name} ${apt.patient_last_name}</strong><br>
                            <small style="color: var(--muted-foreground)">ID: ${apt.patient_id}</small>
                        </td>
                        <td style="padding: 1rem; vertical-align: top;">
                            Dr. ${apt.doctor_first_name} ${apt.doctor_last_name}<br>
                            <small style="color: var(--muted-foreground)">${apt.specialization}</small>
                        </td>
                        <td style="padding: 1rem; vertical-align: top;">
                            ${appointmentDate.toLocaleDateString()}<br>
                            <small style="color: var(--muted-foreground)">${appointmentDate.toLocaleTimeString()}</small>
                        </td>
                        <td style="padding: 1rem; vertical-align: top;">
                            <span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; ${getStatusStyle(apt.status)}">${apt.status}</span>
                        </td>
                        <td style="padding: 1rem; vertical-align: top;">
                            <select onchange="updateAppointmentStatus(${apt.appointment_id}, this.value)" style="background: var(--muted); color: var(--foreground); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 0.875rem; cursor: pointer;">
                                <option value="scheduled" ${apt.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="completed" ${apt.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${apt.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    
        // Get status badge styling
        function getStatusStyle(status) {
            switch(status) {
                case 'scheduled':
                    return 'background: #dbeafe; color: #1e40af;';
                case 'completed':
                    return 'background: #dcfce7; color: #166534;';
                case 'cancelled':
                    return 'background: #fee2e2; color: #dc2626;';
                default:
                    return 'background: var(--muted); color: var(--foreground);';
            }
        }
    
        // Load patients overview
        async function loadPatientsOverview() {
            const patients = await fetchData('/dashboard/patients-overview');
            const tbody = document.getElementById('patients-table');
            
            if (!patients) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load patients</td></tr>';
                return;
            }
    
            if (patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No patients found</td></tr>';
                return;
            }
    
            tbody.innerHTML = patients.map(patient => {
                const dob = patient.dob ? new Date(patient.dob).toLocaleDateString() : 'N/A';
                return `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; vertical-align: top;">
                            <strong>${patient.first_name} ${patient.last_name}</strong><br>
                            <small style="color: var(--muted-foreground)">DOB: ${dob}</small>
                        </td>
                        <td style="padding: 1rem; vertical-align: top;">${patient.email}</td>
                        <td style="padding: 1rem; vertical-align: top;">${patient.phone || 'N/A'}</td>
                        <td style="padding: 1rem; vertical-align: top;">${patient.total_appointments || 0}</td>
                        <td style="padding: 1rem; vertical-align: top;">${patient.total_medications || 0}</td>
                        <td style="padding: 1rem; vertical-align: top;">
                            <a href="/clinic/patients?patient_id=${patient.patient_id}" class="btn btn-primary">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    
        // Load recent activity
        async function loadRecentActivity() {
            const activities = await fetchData('/dashboard/recent-activity');
            const activityDiv = document.getElementById('recent-activity');
            
            if (!activities) {
                activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--destructive);">Failed to load activity</div>';
                return;
            }
    
            if (activities.length === 0) {
                activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--muted-foreground); font-style: italic;">No recent activity</div>';
                return;
            }
    
            activityDiv.innerHTML = activities.map(activity => {
                const activityTime = new Date(activity.time);
                const icon = activity.status === 'completed' ? 'check-circle' : 'calendar-alt';
                
                return `
                    <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--border);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: white; flex-shrink: 0; background: var(--primary);">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--foreground); margin-bottom: 0.25rem;">${activity.title}</div>
                            <div style="color: var(--muted-foreground); font-size: 0.875rem; margin-bottom: 0.25rem;">${activity.description}</div>
                            <div style="color: var(--muted-foreground); font-size: 0.75rem;">${activityTime.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    
        // Update appointment status
        async function updateAppointmentStatus(appointmentId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/clinic/appointments/${appointmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
    
                if (response.ok) {
                    // Reload the appointments table
                    await loadRecentAppointments();
                    await loadRecentActivity();
                    
                    // Show success message
                    showNotification('Appointment status updated successfully');
                } else {
                    throw new Error('Failed to update appointment status');
                }
            } catch (error) {
                console.error('Error updating appointment status:', error);
                showNotification('Failed to update appointment status', false);
            }
        }
    
        // Initialize dashboard
        async function initDashboard() {
            setLoading(true);
            try {
                await Promise.all([
                    updateStats(),
                    loadRecentAppointments(),
                    loadPatientsOverview(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showNotification('Failed to load dashboard data', false);
            } finally {
                setLoading(false);
            }
        }
    
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    
        // Refresh data every 30 seconds
        setInterval(initDashboard, 30000);
    </script>
</body>
</html>
